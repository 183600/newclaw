name: iflow-ts-autoloop

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: iflow-autoflow-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run-ts-5h:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      RUN_HOURS: 5
      WORK_BRANCH: main

      # ÂéªÊéâ typusÔºömarker Êñá‰ª∂ÊîπÂêç
      RELEASE_MARKER_FILE: .git/iflow_release_tag

      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      IFLOW_BASE_URL: https://apis.iflow.cn/v1
      IFLOW_MODEL_NAME: glm-4.6

      GH_TOKEN: ${{ github.token }}

      # Gitee ÈïúÂÉèÊé®ÈÄÅÔºàÂèØÈÄâÔºâ
      GITEE_REMOTE_URL: ${{ secrets.GITEE_REMOTE_URL }}

    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.IFLOW_PAT }}
          fetch-depth: 0

      - name: Ensure branch and git identity
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${WORK_BRANCH:-main}"
          git fetch origin "${BRANCH}" --prune
          git checkout -B "${BRANCH}" "origin/${BRANCH}"
          git config user.name "iflow-bot"
          git config user.email "iflow-bot@users.noreply.github.com"

      # üëá Êñ∞Â¢ûÔºöÂÖàÂÆâË£Ö pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9 # ÊåáÂÆö pnpm ÁâàÊú¨Ôºå‰æãÂ¶Ç 8 Êàñ 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          # üëá Âà†Èô§‰∫ÜÊó†ÊïàÁöÑ 'package-manager' ÂèÇÊï∞
          # üëá ‰øùÊåÅÁºìÂ≠òÈÖçÁΩÆ
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: Enable Corepack (pnpm)
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          pnpm --version

      - name: Install iFlow CLI
        shell: bash
        run: |
          set -euo pipefail
          pnpm add -g @iflow-ai/iflow-cli@latest
          iflow --version

      - name: Verify IFLOW_API_KEY
        shell: bash
        run: |
          set -euo pipefail
          test -n "${IFLOW_API_KEY:-}" || { echo "Missing IFLOW_API_KEY secret"; exit 1; }

      - name: Install Project Dependencies (pnpm)
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile

      - name: Make loop script executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/ts_loop.sh

      - name: Run for ${{ env.RUN_HOURS }} hours
        shell: bash
        run: |
          set -euo pipefail
          timeout --signal=TERM $(( RUN_HOURS * 3600 )) bash scripts/ts_loop.sh || true

      - name: Commit & push once (GitHub + Gitee)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${WORK_BRANCH:-main}"

          # Á°Æ‰øù gitee ËøúÁ´ØÂ≠òÂú®
          if git remote get-url gitee >/dev/null 2>&1; then
            git remote set-url gitee "${GITEE_REMOTE_URL}"
          else
            git remote add gitee "${GITEE_REMOTE_URL}"
          fi

          # ÊúÄÂêéÁªü‰∏ÄÊèê‰∫§‰∏ÄÊ¨°
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "ci: ${RUN_HOURS}h batch update (run $GITHUB_RUN_ID)" || true
          fi

          # Ê£ÄÊü• release markerÔºàÂéªÊéâ typusÔºâ
          MARKER_FILE="${RELEASE_MARKER_FILE}"
          if [[ ! -f "${MARKER_FILE}" ]]; then
            GIT_DIR_REAL="$(git rev-parse --git-dir 2>/dev/null || echo ".git")"
            MARKER_FILE="${GIT_DIR_REAL%/}/iflow_release_tag"
          fi
          if [[ -f "${MARKER_FILE}" ]]; then
            echo "Release tag prepared: $(cat "${MARKER_FILE}")"
          fi

          # Êé®ÈÄÅ
          git push origin "HEAD:${BRANCH}" --follow-tags --force
          # Â¶ÇÊûúÈÖçÁΩÆ‰∫Ü Gitee
          if [[ -n "${GITEE_REMOTE_URL:-}" ]]; then
            git push gitee "HEAD:${BRANCH}" --follow-tags --force
          fi
